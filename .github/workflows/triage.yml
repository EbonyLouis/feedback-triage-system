name: Issue Triage with goose

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

env:
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  GOOSE_PROVIDER: openrouter
  GOOSE_MODEL: anthropic/claude-sonnet-4.5
  GH_TOKEN: ${{ github.token }}

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install goose CLI
        run: |
          mkdir -p /home/runner/.local/bin
          curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh \
            | CONFIGURE=false GOOSE_BIN_DIR=/home/runner/.local/bin bash
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Configure goose for OpenRouter
        run: |
          mkdir -p ~/.config/goose
          cat << 'EOF' > ~/.config/goose/config.yaml
          GOOSE_PROVIDER: "openrouter"
          GOOSE_MODEL: "anthropic/claude-sonnet-4.5"
          keyring: false

          extensions:
            developer:
              bundled: true
              enabled: true
              name: developer
              timeout: 300
              type: builtin
          EOF

      - name: Build triage instructions for goose
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat > instructions.txt << EOF
          You are an issue triage assistant for a GitHub repo.

          Read the issue title and body and decide:
          - category: one of "URGENT", "FEATURE_REQUEST", or "QUESTION"
          - priority: one of "HIGH", "MEDIUM", or "LOW"
          - labels: an array of GitHub label names (strings)
          - response: a short, friendly Markdown comment for the issue author.

          Return ONLY a single JSON object, with no backticks, code fences, or extra text.
          Use this schema exactly:
          {
            "category": "string",
            "priority": "string",
            "labels": ["string"],
            "response": "string"
          }

          Title:
          ${ISSUE_TITLE}

          Body:
          ${ISSUE_BODY}
          EOF

      - name: Run goose triage
        run: |
          goose run --no-session -i instructions.txt \
            | sed -E 's/\x1B\[[0-9;]*[mK]//g' \
            > goose_output.txt

      - name: Apply labels and comment from goose output
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python - "$ISSUE_NUMBER" << 'PY'
          import json, os, re, subprocess, sys

          issue_number = sys.argv[1]

          # Read goose output and extract the first JSON object
          text = open("goose_output.txt", "r", encoding="utf-8").read()
          match = re.search(r'\{.*\}', text, re.S)
          if not match:
              print("No JSON found in goose output:")
              print(text)
              raise SystemExit(1)

          data = json.loads(match.group(0))

          labels = data.get("labels", [])
          priority = data.get("priority", "MEDIUM").lower()
          response = data.get("response", "")

          # Apply labels
          for label in labels:
              if label:
                  subprocess.run(
                      ["gh", "issue", "edit", issue_number, "--add-label", label],
                      check=True,
                  )

          # Add a priority label like priority:high / priority:medium / priority:low
          subprocess.run(
              ["gh", "issue", "edit", issue_number, "--add-label", f"priority:{priority}"],
              check=True,
          )

          # Add triage comment
          if response.strip():
              subprocess.run(
                  ["gh", "issue", "comment", issue_number, "--body", response],
                  check=True,
              )

          print(f"Issue #{issue_number} triaged with goose.")
          PY
