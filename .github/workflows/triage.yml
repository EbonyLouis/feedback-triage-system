name: Issue Triage with Goose

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install goose
        run: |
          pip install goose-ai

      - name: Triage issue with goose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.LLM_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Create a triage script
          cat > triage.py << 'EOF'
          import os
          import json
          import subprocess

          issue_number = os.environ['ISSUE_NUMBER']
          issue_title = os.environ['ISSUE_TITLE']
          issue_body = os.environ['ISSUE_BODY']

          # Analyze the issue and categorize it
          prompt = f"""
          Analyze this issue and categorize it:
          
          Title: {issue_title}
          Body: {issue_body}
          
          Categorize as one of: URGENT, FEATURE_REQUEST, QUESTION
          Provide a priority (HIGH, MEDIUM, LOW)
          Suggest appropriate labels
          Write a brief triage response
          
          Format your response as JSON with keys: category, priority, labels (array), response
          """
          
          # Determine category based on keywords
          category = "QUESTION"
          priority = "MEDIUM"
          labels = []
          
          title_lower = issue_title.lower()
          body_lower = issue_body.lower()
          
          if any(word in title_lower or word in body_lower for word in ['urgent', 'asap', 'emergency', 'not working', 'broken', 'stopped']):
              category = "URGENT"
              priority = "HIGH"
              labels = ["urgent", "bug"]
          elif any(word in title_lower or word in body_lower for word in ['add', 'feature', 'request', 'could we', 'suggestion']):
              category = "FEATURE_REQUEST"
              priority = "MEDIUM"
              labels = ["enhancement", "feature-request"]
          elif any(word in title_lower or word in body_lower for word in ['where', 'how', 'question', 'asked']):
              category = "QUESTION"
              priority = "MEDIUM"
              labels = ["question"]
          
          # Generate response based on category
          if category == "URGENT":
              response = f"ğŸš¨ **URGENT ISSUE DETECTED**\\n\\nThis issue has been automatically categorized as urgent and requires immediate attention.\\n\\n**Priority:** {priority}\\n**Category:** {category}\\n\\nThe team has been notified and will address this as soon as possible."
          elif category == "FEATURE_REQUEST":
              response = f"ğŸ’¡ **FEATURE REQUEST**\\n\\nThank you for your suggestion! This has been categorized as a feature request.\\n\\n**Priority:** {priority}\\n**Category:** {category}\\n\\nWe'll review this and consider it for future improvements."
          else:
              response = f"â“ **QUESTION**\\n\\nThank you for your question! This has been categorized appropriately.\\n\\n**Priority:** {priority}\\n**Category:** {category}\\n\\nSomeone from the team will respond with the information you need."
          
          # Add labels to the issue
          for label in labels:
              subprocess.run(['gh', 'issue', 'edit', issue_number, '--add-label', label], check=True)
          
          # Add priority label
          subprocess.run(['gh', 'issue', 'edit', issue_number, '--add-label', f'priority:{priority.lower()}'], check=True)
          
          # Add comment with triage response
          subprocess.run(['gh', 'issue', 'comment', issue_number, '--body', response], check=True)
          
          print(f"âœ… Issue #{issue_number} triaged successfully!")
          print(f"Category: {category}, Priority: {priority}, Labels: {labels}")
          EOF
          
          python triage.py
